<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendingTech Daily - Admin Dashboard</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <link rel="stylesheet" href="/admin/admin.css">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 sidebar">
                <div class="d-flex flex-column">
                    <h4 class="text-white text-center mb-4">Admin Panel</h4>
                    <div id="admin-sidebar">
                        <p class="text-center text-white">Loading...</p>
                    </div>
                </div>
            </div>

            <div class="col main-content">
                <header class="admin-header d-flex justify-content-between align-items-center">
                    <h2>TrendingTech Daily Admin</h2>
                    <div class="user-controls">
                        <span id="user-email" class="me-3"></span>
                        <button id="logout-btn" class="btn btn-sm btn-outline-secondary">Logout</button>
                    </div>
                </header>

                <div id="content-area">
                    <div class="section-container">
                        <h3>Welcome to the Admin Dashboard</h3>
                        <p>Select a section from the sidebar to get started.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAMMvOPS6fczzI_2CTOcc_NlGGFO4qDydg", // Consider using environment variables for keys
            authDomain: "trendingtech-daily.firebaseapp.com",
            projectId: "trendingtech-daily",
            storageBucket: "trendingtech-daily.firebasestorage.app",
            messagingSenderId: "343812872871",
            appId: "1:343812872871:web:5bd68bd7d6140d83551982"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // --- Create global Firebase service variables ---
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
        const functions = firebase.functions();
        // --- End Global Firebase service variables ---

    </script>

    <script src="/admin/components/sections.js"></script>
    <script src="/admin/components/articles.js"></script>
    <script src="/admin/components/mediaUploader.js"></script>
    <script src="/admin/components/settings.js"></script>
    <script src="/admin/components/sidebar.js"></script>


    <script>
        // Check if user is authenticated and has admin privileges
        auth.onAuthStateChanged(function(user) {
            if (user) {
                // User is signed in
                document.getElementById('user-email').textContent = user.email;

                // Check if user is admin
                user.getIdTokenResult().then((idTokenResult) => {
                    if (idTokenResult.claims.admin) {
                        // User is admin, initialize admin components
                        console.log("Admin user confirmed. Initializing dashboard...");
                        initializeAdminDashboard();
                    } else {
                        // Not an admin, redirect to login or show error
                        console.warn('User is not an admin. Redirecting.');
                        alert('You do not have administrative privileges.');
                        auth.signOut(); // Sign out non-admin
                        window.location.href = '/admin/admin.html'; // Redirect to login
                    }
                }).catch(error => {
                     console.error("Error getting ID token result:", error);
                     alert('Error verifying admin status. Please try logging in again.');
                     auth.signOut();
                     window.location.href = '/admin/admin.html';
                });
            } else {
                // No user is signed in, redirect to login
                console.log("No user signed in. Redirecting to login.");
                window.location.href = '/admin/admin.html';
            }
        });

        // Logout functionality (ensure button exists before adding listener)
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                auth.signOut().then(() => {
                    window.location.href = '/admin/admin.html';
                }).catch((error) => {
                    console.error('Error signing out:', error);
                    alert('Error signing out. Please try again.');
                });
            });
        } else {
            console.error("Logout button not found!");
        }


        // Initialize admin dashboard components
        function initializeAdminDashboard() {
            // Initialize sidebar
            if (typeof initSidebar === 'function') {
                initSidebar();
                // Load default section *after* sidebar is ready
                // Set default active section (e.g., Articles)
                 if (typeof loadArticlesSection === 'function') {
                    console.log("Loading default section: Articles");
                    loadArticlesSection(); // Load default view
                 } else {
                    console.error("loadArticlesSection function not found!");
                    document.getElementById('content-area').innerHTML = `<div class="alert alert-danger">Error: Cannot load the default Articles section.</div>`;
                 }
            } else {
                 console.error("initSidebar function not found!");
                 document.getElementById('content-area').innerHTML = `<div class="alert alert-danger">Error: Cannot initialize the admin sidebar.</div>`;
            }
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
          console.log("DOM Fully Loaded.");
          console.log("Checking function existence:");
          console.log("Articles function exists:", typeof loadArticlesSection === 'function');
          console.log("Sections function exists:", typeof loadSectionsManager === 'function');
          console.log("Media function exists:", typeof loadMediaUploader === 'function');
          console.log("Settings function exists:", typeof loadSettingsPanel === 'function');
          console.log("Sidebar function exists:", typeof initSidebar === 'function');

          const scriptsLoaded = Array.from(document.getElementsByTagName('script'))
            .map(script => script.src)
            .filter(src => src && src.includes('/admin/components/'));

          console.log("Admin component scripts found in DOM:", scriptsLoaded);
        });
    </script>

</body>
</html>