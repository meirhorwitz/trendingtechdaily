<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results - TrendingTech Daily</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=IBM+Plex+Sans:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="navbar-placeholder"></div>

    <!-- Main Container -->
    <div class="container mt-4">
        <!-- Search Box -->
        <section class="mb-4">
            <h1 class="section-title">Search Articles</h1>
            <form action="/search.html" method="GET" id="searchPageForm" class="mb-3">
                <div class="input-group">
                    <input type="text" 
                           id="searchInput" 
                           name="q" 
                           class="form-control form-control-lg" 
                           placeholder="Search for articles..." 
                           autocomplete="off"
                           required>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
            </form>
            <div id="searchMeta" class="text-muted text-center mb-4" style="display: none;">
                Found <strong id="resultCount">0</strong> results for "<strong id="searchQueryDisplay"></strong>"
            </div>
        </section>

        <!-- Main Content Grid -->
        <div class="row">
            <!-- Search Results Column -->
            <div class="col-lg-8">
                <!-- AI Summary -->
                <div id="aiSummarySection" class="ai-section mb-4" style="display: none;">
                    <h3>AI-Generated Summary</h3>
                    <p id="aiSummaryContent"></p>
                </div>

                <!-- AI Tips -->
                <div id="aiTipsSection" class="ai-section mb-4" style="display: none;">
                    <h3>AI Suggestions & Tips</h3>
                    <ul id="aiTipsContent"></ul>
                </div>

                <!-- Search Results -->
                <div id="searchResults">
                    <div class="text-center py-5">
                        <i class="bi bi-search" style="font-size: 4rem; color: var(--color-text-muted);"></i>
                        <h3 class="mt-3">Start Your Search</h3>
                        <p class="text-muted">Enter a keyword or topic above to find relevant articles</p>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Trending Topics -->
                <div class="sidebar-section">
                    <h4>Trending Topics</h4>
                    <ul id="trendingTopicsList" class="trending-topics-list">
                        <li class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </li>
                    </ul>
                </div>

                <!-- Filters -->
                <div class="sidebar-section">
                    <h4>Filter Results</h4>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            <!-- Categories will be loaded dynamically from Firebase -->
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Sort By</label>
                        <select class="form-select" id="sortFilter">
                            <option value="relevance">Relevance</option>
                            <option value="date">Date (Newest)</option>
                            <option value="views">Most Viewed</option>
                        </select>
                    </div>
                </div>

                <!-- Recent Searches -->
                <div class="sidebar-section">
                    <h4>Recent Searches</h4>
                    <ul id="recentSearchesList" class="trending-topics-list">
                        <li class="text-muted">No recent searches</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="text-center copyright">
                <p>&copy; 2024 TrendingTech Daily. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="/js/config.js"></script>
    <script>
// Inline search.js to avoid loading conflicts
  document.addEventListener('DOMContentLoaded', async function() {
  const searchInput = document.getElementById('searchInput');
  const searchQueryDisplay = document.getElementById('searchQueryDisplay');
  const searchResultsDiv = document.getElementById('searchResults');
  const trendingTopicsList = document.getElementById('trendingTopicsList');
  const searchMeta = document.getElementById('searchMeta');
  const resultCount = document.getElementById('resultCount');
  
  const aiSummarySection = document.getElementById('aiSummarySection');
  const aiSummaryContent = document.getElementById('aiSummaryContent');
  const aiTipsSection = document.getElementById('aiTipsSection');
  const aiTipsContent = document.getElementById('aiTipsContent');

  const categoryFilter = document.getElementById('categoryFilter');
  const sortFilter = document.getElementById('sortFilter');
  const recentSearchesList = document.getElementById('recentSearchesList');
  
  // Category name mapping - will be populated from database
  let categoryNames = {};
  let categorySlugs = {};
  
  let currentResults = [];
  let currentQuery = '';

  if (!firebase || !firebase.apps.length) {
    console.error('Firebase not initialized');
    searchResultsDiv.innerHTML = '<div class="alert alert-danger">Search is temporarily unavailable.</div>';
    return;
  }
  
  const db = firebase.firestore();

  // Load categories for filter dropdown and mapping
  async function loadCategories() {
    try {
      let snapshot = await db.collection('categories').orderBy('name').get();

      if (snapshot.empty) {
        console.log("No documents in 'categories' collection, trying 'sections'");
        snapshot = await db.collection('sections').orderBy('name').get();
      }

      if (!snapshot.empty) {
        categoryFilter.innerHTML = '<option value="">All Categories</option>';

        snapshot.forEach(doc => {
          const data = doc.data();
          const categoryId = doc.id;
          const categoryName = data.name || categoryId;
          const categorySlug = data.slug || categoryId;

          categoryNames[categoryId] = categoryName;
          categorySlugs[categoryId] = categorySlug;

          const option = document.createElement('option');
          option.value = categoryId;
          option.textContent = categoryName;
          categoryFilter.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading categories:', error);
    }
  }

  function generateAiSummary(articles) {
    if (articles.length === 0) {
      aiSummarySection.style.display = 'none';
      return;
    }

    const categories = new Set();
    articles.forEach(article => {
      if (article.categoryName) categories.add(article.categoryName);
    });

    let summaryText = `Found ${articles.length} article${articles.length !== 1 ? 's' : ''} `;
    if (categories.size > 0) {
      summaryText += `in ${Array.from(categories).join(', ')}. `;
    }
    
    if (articles[0] && articles[0].excerpt) {
      summaryText += `Most relevant: "${articles[0].title}".`;
    }
    
    aiSummaryContent.textContent = summaryText;
    aiSummarySection.style.display = 'block';
  }

  function generateAiTips(query, articles) {
    if (articles.length === 0) {
      aiTipsSection.style.display = 'none';
      return;
    }

    const tips = [];
    const allTags = new Set();
    
    articles.forEach(article => {
      if (article.tags && Array.isArray(article.tags)) {
        article.tags.forEach(tag => allTags.add(tag));
      }
    });
    
    if (allTags.size > 0) {
      const relatedTopics = Array.from(allTags).slice(0, 3);
      tips.push(`Try related topics: ${relatedTopics.join(', ')}`);
    }
    
    tips.push(`Use quotes for exact phrases: "${query}"`);
    tips.push(`Filter by category or sort by date for better results`);
    
    aiTipsContent.innerHTML = tips.map(tip => `<li>${tip}</li>`).join('');
    aiTipsSection.style.display = 'block';
  }

  function displayArticles(articles) {
    searchResultsDiv.innerHTML = '';
    
    if (articles.length === 0) {
      searchResultsDiv.innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-search" style="font-size: 4rem; color: var(--color-text-muted);"></i>
          <h3 class="mt-3">No Results Found</h3>
          <p class="text-muted">Try different keywords or check the trending topics</p>
        </div>
      `;
      searchMeta.style.display = 'none';
      return;
    }

    resultCount.textContent = articles.length;
    searchMeta.style.display = 'block';
    
    articles.forEach(article => {
      const articleDate = article.publishedAt
        ? new Date(article.publishedAt.toDate ? article.publishedAt.toDate() : article.publishedAt)
            .toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
        : article.createdAt
          ? new Date(
              article.createdAt.toDate
                ? article.createdAt.toDate()
                : article.createdAt._seconds
                  ? article.createdAt._seconds * 1000
                  : article.createdAt
            ).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
          : 'Date not available';
      
      const excerpt = article.excerpt || 'No preview available';
      const imageUrl = article.featuredImage || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y4ZjlmYSIvPgogIDx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM2Yzc1N2QiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4=';
      
      // Get category display name
      const categoryId = article.category || article.categoryName || '';
      const categoryDisplay = categoryNames[categoryId] || categoryId || 'Uncategorized';
      const categorySlug = categorySlugs[categoryId] || categoryId;
      const link = categorySlug ? `/${categorySlug}/${article.slug}` : `/article.html?slug=${article.slug}`;

      const articleCard = `
        <div class="article-card mb-3">
          <div class="row g-0">
            <div class="col-md-4">
              <div class="article-image-container" style="height: 200px;">
                <img src="${imageUrl}" alt="${article.title}" class="article-image">
              </div>
            </div>
            <div class="col-md-8">
              <div class="article-content">
                <h2 class="article-title">
                  <a href="${link}">${article.title}</a>
                </h2>
                <p class="article-description">${excerpt}</p>
                <div class="article-meta">
                  <span class="badge bg-primary">${categoryDisplay}</span>
                  <span class="text-muted small">
                    <i class="bi bi-clock-history"></i> ${articleDate}
                  </span>
                  <span class="text-muted small">
                    <i class="bi bi-eye"></i> ${article.views || 0} views
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      searchResultsDiv.innerHTML += articleCard;
    });
  }

  async function performSearch(query, filters = {}) {
    const trimmedQuery = query.toLowerCase().trim();
    
    searchQueryDisplay.textContent = query;
    document.title = `Search: ${query} - TrendingTech Daily`;
    searchResultsDiv.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Searching...</span></div></div>';
    
    aiSummarySection.style.display = 'none';
    aiTipsSection.style.display = 'none';

    if (trimmedQuery.length === 0) {
      searchResultsDiv.innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-search" style="font-size: 4rem; color: var(--color-text-muted);"></i>
          <h3 class="mt-3">Enter a Search Term</h3>
          <p class="text-muted">Type something in the search box above</p>
        </div>
      `;
      searchMeta.style.display = 'none';
      return;
    }

    try {
      const articles = [];
      let articlesQuery = db.collection('articles').where('published', '==', true);
      
      if (filters.category) {
        articlesQuery = articlesQuery.where('category', '==', filters.category);
      }
      
      const snapshot = await articlesQuery.get();
      
      snapshot.forEach(doc => {
        const data = doc.data();
        const searchText = [
          data.title || '',
          data.content || '',
          data.excerpt || '',
          ...(data.tags || [])
        ].join(' ').toLowerCase();

        if (searchText.includes(trimmedQuery)) {
          articles.push({ id: doc.id, ...data });
        }
      });
      
      // Sort articles
      articles.forEach(article => {
        let score = 0;
        const titleLower = (article.title || '').toLowerCase();
        if (titleLower.includes(trimmedQuery)) score += 50;
        article.relevanceScore = score;
      });
      
      if (filters.sort === 'date') {
        articles.sort((a, b) => (b.createdAt?._seconds || 0) - (a.createdAt?._seconds || 0));
      } else if (filters.sort === 'views') {
        articles.sort((a, b) => (b.views || 0) - (a.views || 0));
      } else {
        articles.sort((a, b) => b.relevanceScore - a.relevanceScore);
      }

      currentResults = articles;
      currentQuery = query;
      
      displayArticles(articles);
      generateAiSummary(articles);
      generateAiTips(query, articles);
      
      // Save to recent searches
      try {
        let recent = JSON.parse(localStorage.getItem('recent_searches') || '[]');
        recent = recent.filter(q => q !== query);
        recent.unshift(query);
        recent = recent.slice(0, 5);
        localStorage.setItem('recent_searches', JSON.stringify(recent));
        displayRecentSearches();
      } catch (e) {}

    } catch (error) {
      console.error('Search error:', error);
      searchResultsDiv.innerHTML = '<div class="alert alert-danger">Search failed. Please try again.</div>';
      searchMeta.style.display = 'none';
    }
  }
  
  async function loadTrendingTopics() {
    try {
      const snapshot = await db.collection('articles')
        .where('published', '==', true)
        .orderBy('views', 'desc')
        .limit(5)
        .get();

      if (snapshot.empty) {
        // Try alternative query without views field
        const altSnapshot = await db.collection('articles')
          .where('published', '==', true)
          .orderBy('publishedAt', 'desc')
          .limit(5)
          .get();
          
        if (altSnapshot.empty) {
          trendingTopicsList.innerHTML = '<li class="text-muted">No trending topics</li>';
          return;
        }
        
        trendingTopicsList.innerHTML = '';
        altSnapshot.forEach(doc => {
          const article = doc.data();
          const categorySlug = categorySlugs[article.category] || article.category;
          const link = categorySlug ? `/${categorySlug}/${article.slug}` : `/article.html?slug=${article.slug}`;
          trendingTopicsList.innerHTML += `<li><a href="${link}">${article.title}</a></li>`;
        });
      } else {
        trendingTopicsList.innerHTML = '';
        snapshot.forEach(doc => {
          const article = doc.data();
          const categorySlug2 = categorySlugs[article.category] || article.category;
          const link2 = categorySlug2 ? `/${categorySlug2}/${article.slug}` : `/article.html?slug=${article.slug}`;
          trendingTopicsList.innerHTML += `<li><a href="${link2}">${article.title}</a></li>`;
        });
      }

    } catch (error) {
      console.error('Error loading trending:', error);
      // If views field doesn't exist, try without it
      try {
        const fallbackSnapshot = await db.collection('articles')
          .where('published', '==', true)
          .limit(5)
          .get();
          
        if (!fallbackSnapshot.empty) {
          trendingTopicsList.innerHTML = '';
          fallbackSnapshot.forEach(doc => {
            const article = doc.data();
            const categorySlug3 = categorySlugs[article.category] || article.category;
            const link3 = categorySlug3 ? `/${categorySlug3}/${article.slug}` : `/article.html?slug=${article.slug}`;
            trendingTopicsList.innerHTML += `<li><a href="${link3}">${article.title}</a></li>`;
          });
        } else {
          trendingTopicsList.innerHTML = '<li class="text-muted">No articles found</li>';
        }
      } catch (fallbackError) {
        console.error('Fallback query also failed:', fallbackError);
        trendingTopicsList.innerHTML = '<li class="text-danger">Failed to load</li>';
      }
    }
  }

  function displayRecentSearches() {
    try {
      const recent = JSON.parse(localStorage.getItem('recent_searches') || '[]');
      if (recent.length === 0) {
        recentSearchesList.innerHTML = '<li class="text-muted">No recent searches</li>';
        return;
      }
      recentSearchesList.innerHTML = recent
        .map(s => `<li><a href="/search.html?q=${encodeURIComponent(s)}">${s}</a></li>`)
        .join('');
    } catch (e) {}
  }

  // Event listeners
  document.getElementById('searchPageForm').addEventListener('submit', (e) => {
    e.preventDefault();
    performSearch(searchInput.value, {
      category: categoryFilter.value,
      sort: sortFilter.value
    });
  });
  
  categoryFilter.addEventListener('change', () => {
    if (currentQuery) performSearch(currentQuery, {
      category: categoryFilter.value,
      sort: sortFilter.value
    });
  });
  
  sortFilter.addEventListener('change', () => {
    if (currentQuery && currentResults.length > 0) {
      performSearch(currentQuery, {
        category: categoryFilter.value,
        sort: sortFilter.value
      });
    }
  });
  
  // Initialize
  await loadCategories();
  const urlParams = new URLSearchParams(window.location.search);
  const queryFromUrl = urlParams.get('q');
  if (queryFromUrl) {
    searchInput.value = queryFromUrl;
    await performSearch(queryFromUrl);
  }

  loadTrendingTopics();
  displayRecentSearches();
});
    </script>
    <script src="/js/auth.js"></script>
    <script src="/js/nav-loader.js"></script>
</body>
</html>